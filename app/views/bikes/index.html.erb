<script type = "text/javascript">
    $(document).ready(function(){
        var sorter;
        var reverseSort = false;
        var prevSort = $(".active.sortup")[0];
        var currentMin = 0;
        // Attach filters
        function attachListeners(){
            $("#searchButton").click(function(){
                populateBikeList();
            });
            $(".checkColor").each(function(){
                $(this).click(function(){
                    populateBikeList();
                });
            });
            $(".checkStatus").each(function(){
                $(this).click(function(){
                    populateBikeList();
                });
            });
            $(".allFilter").each(function(){
                $(this).click(function(){
                    var thisFilter = $(this).attr("id");
                    var thisFilterType = thisFilter.substring(3);
                    $(".check"+thisFilterType).each(function(){
                        $(this).attr("checked","checked");
                    });
                    populateBikeList();
                });
            });
            $(".noFilter").each(function(){
                $(this).click(function(){
                    var thisFilter = $(this).attr("id");
                    var thisFilterType = thisFilter.substring(2);
                    $(".check"+thisFilterType).each(function(){
                        $(this).attr("checked",false);
                    });
                });
            });
            $(".sortup").each(function(){
                $(this).click(function(){
                    reverseSort = false;
                    if(prevSort){
                        $(prevSort).removeClass("active");
                    }
                    prevSort = $(this);
                    $(this).addClass("active");
                    sorter = $(this).parent().siblings(".sorter");
                    populateBikeList();
                });
            });
            $(".sortdown").each(function(){
                $(this).click(function(){
                    reverseSort = true;
                    if(prevSort){
                        $(prevSort).removeClass("active");
                    }
                    prevSort = $(this);
                    $(this).addClass("active");
                    sorter = $(this).parent().siblings(".sorter");
                    populateBikeList();
                });
            });
            attachRowListeners();
        }

        function attachRowListeners(){
            $(".bikeRow").each(function(){
                $(this).click(function(){
                    getBikeDetails($(this));
                });
            });
        }

        function getBikeDetails(bike){
            bike = bike[0];
            var bikeNumber = bike.children[0].children[0].innerHTML;
            $.ajax({
                type: "GET",
                url: "/bikes/get_details/" + bikeNumber,
                dataType : "json",
                success: function (response){
                    renderBikeDetails(response);
                }
            });
        }

        function convert_wheel_size(ws){
            if(ws !== null){
                if(ws <= 1){
                    return "Unknown";
                }else{
                    return ws + " mm";
                }
            }else{
                return "n/a";
            }
        }

        function renderBikeDetails(bike){
            $("#bikeDetailBrand").html(bike.brand_name || "n/a");
            $("#bikeDetailModel").html(bike.model_name || "n/a");
            $("#bikeDetailColor").html(bike.color);
            $("#bikeDetailWheelSize").html(convert_wheel_size(bike.wheel_size));
            $("#bikeDetailSeatTube").html(bike.seat_tube_height ? bike.seat_tube_height + " in." : "n/a");
            $("#bikeDetailTopTube").html(bike.top_tube_length ? bike.top_tube_length + " in." : "n/a");
            $("#bikeDetailQuality").html(bike.quality);
            $("#bikeDetailCondition").html(bike.condition);
            $("#bikeDetailValue").html(bike.value || "n/a");
            $("#bikeDetailStatus").html(bike.name || "Available");
            var formattedDate = dp(bike.created_at);    
            $("#bikeDetailDate").html((formattedDate.getMonth()+1) + "/" + formattedDate.getDate() + "/" + formattedDate.getFullYear());

        }

        // Function to get bikes
        function populateBikeList(min,max,viewAll){
            min = min || 0;
            max = max || 10;
            viewAll = viewAll || false;
            var colorArr = $("input:checkbox:checked.checkColor").map(function(){
                return this.value;
            }).get();
            var statusArr = $("input:checkbox:checked.checkStatus").map(function(){
                return this.value;
            }).get();
            var searchDesc = $("#searchDesc").val();
            var sortBy = (sorter ? sorter.attr("fieldname") : "number");
            if(reverseSort){
                sortBy = sortBy + " DESC";
            }
            $.ajax({
                type: "GET",
                url: "/bikes/filter_bikes/filter",
                data: {
                    "colors" : colorArr,
                    "statuses" : statusArr,
                    "sortBy" : sortBy,
                    "searchDesc" : searchDesc,
                    "min" : min,
                    "max" : max,
                    "all" : viewAll
                },
                dataType : "json",
                success: function (response){
                    currentMin = parseInt(min)/10;
                    renderHtml(response,viewAll);
                    attachRowListeners();
                }
            });
        }

        function setupPagination(count){
            $("#pagination").html("");
            //Setup first three pages
            if(currentMin-3 > 0){
                var firstPage = document.createElement("span");
                firstPage.innerHTML = "first";
                $(firstPage).click(function(){
                    populateBikeList(0,10);
                });
                $("#pagination").append(firstPage);
                for(var i = currentMin-3; i < currentMin; i++){
                    var newPage = document.createElement("span");
                    newPage.innerHTML = i;
                    $(newPage).click(function(){
                        var thisPageNum = (parseInt($(this).html()))*10;
                        populateBikeList(thisPageNum,thisPageNum+10);
                    });
                    $("#pagination").append(newPage);
                }
            }else{
                for(var i = currentMin - 3; i < currentMin; i++){
                    if(i >= 0){
                        var newPage = document.createElement("span");
                        newPage.innerHTML = i;
                        $(newPage).click(function(){
                            var thisPageNum = (parseInt($(this).html()))*10;
                            populateBikeList(thisPageNum,thisPageNum+10);
                        });
                        $("#pagination").append(newPage);
                    }
                }
            }
            //Setup current page
            var currentPage = document.createElement("span");
            currentPage.innerHTML = currentMin;
            currentPage.className = "currentPage";
            $(currentPage).click(function(){
                populateBikeList(currentMin,currentMin+10);
            });
            $("#pagination").append(currentPage);

            //Setup last three pages
            if(currentMin + 4 < Math.floor(count/10)){
                for(var i = currentMin+1; i < currentMin+4; i++){
                    var newPage = document.createElement("span");
                    newPage.innerHTML = i;
                    $(newPage).click(function(){
                        var thisPageNum = (parseInt($(this).html()))*10;
                        populateBikeList(thisPageNum,thisPageNum+10);
                    });
                    $("#pagination").append(newPage);
                }
                var lastPage = document.createElement("span");
                lastPage.innerHTML = "last";
                $(lastPage).click(function(){
                    populateBikeList(Math.floor(count/10)*10,Math.floor(count/10)*10+10);
                });
                $("#pagination").append(lastPage);
            }else{
                for(var i = currentMin+1; i < currentMin+4; i++){
                    if(i < count/10){
                        var newPage = document.createElement("span");
                        newPage.innerHTML = i;
                        $(newPage).click(function(){
                            var thisPageNum = (parseInt($(this).html()))*10;
                            populateBikeList(thisPageNum,thisPageNum+10);
                        });
                        $("#pagination").append(newPage);
                    }
                }

            }
            // Setup View All Page
            var viewAll = document.createElement("span");
            viewAll.innerHTML = "View All";
            $(viewAll).click(function(){
                populateBikeList(0,Math.floor(count/10)*10,true);
                $("#pagination").html("");
            });
            $("#pagination").append(viewAll);
        }

        function renderHtml(response,viewAll){
            if(response.count.numbikes == 0){
            $("#bikeList").html("No bikes found!");
            }else{
            $("#bikeList").html("");
            if(!viewAll){
                setupPagination(response.count.numbikes);
            }
            for(var i = 0; i < response.bikes.length; i++){
                var bikeObj = response.bikes[i];
                var newRow = document.createElement("tr");
                newRow.className = "bikeRow"
                // Bike Number
                var bikeNumber = document.createElement("td");
                var bikeNumberLink = document.createElement("a");
                bikeNumberLink.href = "/bikes/sn-"+bikeObj.number;
                bikeNumberLink.innerHTML = bikeObj.number;
                bikeNumber.appendChild(bikeNumberLink);

                // Bike Status
                var bikeAvailable = document.createElement("td");
                if(bikeObj.name && !bikeObj.departed_at){
                    var bikeStatusLink = document.createElement("a");
                    bikeStatusLink.href = "/programs/" + bikeObj.program_id;
                    bikeStatusLink.innerHTML = bikeObj.name;
                    bikeAvailable.appendChild(bikeStatusLink);
                }else{
                    bikeAvailable.innerHTML = (bikeObj.departed_at ? "Departed as " + bikeObj.name : bikeObj.name || "Available");
                }

                // Bike Hook
                var bikeHook = document.createElement("td");
                if (bikeObj.hook_number){
                    var bikeHookLink = document.createElement("a");
                    bikeHookLink.href = "/hooks/location-"+bikeObj.hook_number;
                    bikeHookLink.innerHTML = bikeObj.hook_number;
                    bikeHook.appendChild(bikeHookLink);
                }else{
                    bikeHook.innerHTML = "n/a";
                }

                // Color
                var bikeColor = document.createElement("td");
                bikeColor.innerHTML = bikeObj.color;
                
                // Brand
                var bikeBrand = document.createElement("td");
                bikeBrand.innerHTML = bikeObj.brand_name || "n/a";
                
                // Seat Tube
                var bikeSeat = document.createElement("td");
                bikeSeat.innerHTML = (bikeObj.seat_tube_height ? bikeObj.seat_tube_height + " inches" : "n/a");
                
                // Wheel Size
                var bikeWheel = document.createElement("td");
                bikeWheel.innerHTML = convert_wheel_size(bikeObj.wheel_size);
                
                $(newRow).append(bikeNumber).append(bikeAvailable).append(bikeHook).append(bikeColor).append(bikeBrand).append(bikeSeat)
                .append(bikeWheel);
                $("#bikeList").append(newRow);
            }
            }
        }

        function dp(dateStr) {
            return new Date(dateStr)
        }


        attachListeners();
        populateBikeList();
    });
</script>
<section class="">
<%= render :partial=>"bike_filter" %>
<%= render :partial=>"bike_table", :layout =>"bike_table_layout" %>
<%= render :partial=>"bike_listing_details" %>
</section>
